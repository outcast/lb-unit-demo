error_log /var/log/nginx/error.log;

upstream workers {
    zone workers 64k;
    #state /var/lib/nginx/state/http_backend.state;
    %{ for node in jsondecode(worker_nodes) ~}
server ${node.ipv4_address_private}:8400;
    %{ endfor ~}

}

upstream foo {
    zone foo 64k;
    server ${foo}:8400;
}

upstream bar {
    zone bar 64k;
    server ${bar}:8400;
}

upstream blah {
    zone blah 64k;
    server ${blah}:8400;
}

error_log /var/log/nginx/error.log;

map $http_host $host_upstream {
  ~(.*)\.atpco\.org $1;
  default workers;
}

map $arg_env $upstream {
  "gtst" "foo";
  "monkey" "blah";
  default $host_upstream;
}


server {

    access_log /var/log/nginx/lb-access.log combined;
    listen 80;
    server_name *.atpco.org atpco.org www.atpco.org;
    if ($arg_env) {
      set $current_uri $uri;
      rewrite ^ /upstream-map last;
    }

    location / {
        proxy_set_header Host $host;
        proxy_pass http://workers;
        add_header WORKER $upstream_addr;
        add_header SERVER_NAME $http_host;
        add_header QUERY $query_string;
        add_header UPSTREAM $upstream;
        add_header ARGS $args;
        health_check;
    }

    location ~ /upstream-map {
        internal;
        proxy_set_header Host $host;
        proxy_pass http://$upstream$current_uri?$query_string;
        add_header WORKER $upstream_addr;
        add_header UPSTREAM $upstream;
        add_header SERVER_NAME $http_host;
        add_header CURRENT $current_uri;
    }
}
